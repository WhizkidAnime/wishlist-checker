const CACHE_NAME = 'wishlist-v2.2.0-cache-fix';
const STATIC_CACHE_NAME = 'wishlist-static-v2.2.0-cache-fix';
const DYNAMIC_CACHE_NAME = 'wishlist-dynamic-v2.2.0-cache-fix';

// Ð ÐµÑÑƒÑ€ÑÑ‹ Ð´Ð»Ñ ÐºÑÑˆÐ¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ Ð¿Ñ€Ð¸ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐµ
const STATIC_ASSETS = [
  '/wishlist-checker/',
  '/wishlist-checker/index.html',
  '/wishlist-checker/manifest.json',
  '/wishlist-checker/icons/wishlist-icon.svg',
  '/wishlist-checker/icons/icon-192x192.png',
  '/wishlist-checker/icons/icon-512x512.png'
];

// Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Service Worker
self.addEventListener('install', (event) => {
  console.log('[SW] Installing Service Worker...');
  
  event.waitUntil(
    caches.open(STATIC_CACHE_NAME)
      .then((cache) => {
        console.log('[SW] Caching static assets');
        return cache.addAll(STATIC_ASSETS);
      })
      .catch((error) => {
        console.error('[SW] Error caching static assets:', error);
      })
  );
  
  // ÐŸÑ€Ð¸Ð½ÑƒÐ´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð°Ñ Ð°ÐºÑ‚Ð¸Ð²Ð°Ñ†Ð¸Ñ
  self.skipWaiting();
});

// ÐÐºÑ‚Ð¸Ð²Ð°Ñ†Ð¸Ñ Service Worker
self.addEventListener('activate', (event) => {
  console.log('[SW] Activating Service Worker...');
  
  event.waitUntil(
    caches.keys()
      .then((cacheNames) => {
        return Promise.all(
          cacheNames.map((cacheName) => {
            // Ð£Ð´Ð°Ð»ÑÐµÐ¼ ÑÑ‚Ð°Ñ€Ñ‹Ðµ ÐºÑÑˆÐ¸
            if (cacheName !== STATIC_CACHE_NAME && cacheName !== DYNAMIC_CACHE_NAME) {
              console.log('[SW] Deleting old cache:', cacheName);
              return caches.delete(cacheName);
            }
          })
        );
      })
      .then(() => {
        // ðŸš¨ ÐšÐ Ð˜Ð¢Ð˜Ð§Ð•Ð¡ÐšÐ˜ Ð’ÐÐ–ÐÐž: ÐŸÑ€Ð¸Ð½ÑƒÐ´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ Ð¾Ñ‡Ð¸Ñ‰Ð°ÐµÐ¼ Ð²ÑÐµ ÐºÑÑˆÐ¸ Ñ Supabase Ð´Ð°Ð½Ð½Ñ‹Ð¼Ð¸
        console.log('[SW] SECURITY FIX: Clearing all Supabase caches...');
        return caches.keys().then(cacheNames => {
          return Promise.all(
            cacheNames.map(cacheName => {
              return caches.open(cacheName).then(cache => {
                return cache.keys().then(requests => {
                  return Promise.all(
                    requests.map(request => {
                      if (request.url.includes('supabase.co')) {
                        console.log('[SW] SECURITY FIX: Deleting Supabase cache entry:', request.url);
                        return cache.delete(request);
                      }
                    })
                  );
                });
              });
            })
          );
        });
      })
      .then(() => {
        console.log('[SW] Service Worker activated');
        // Ð‘ÐµÑ€ÐµÐ¼ ÐºÐ¾Ð½Ñ‚Ñ€Ð¾Ð»ÑŒ Ð½Ð°Ð´ Ð²ÑÐµÐ¼Ð¸ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð°Ð¼Ð¸
        return self.clients.claim();
      })
  );
});

// ÐŸÐµÑ€ÐµÑ…Ð²Ð°Ñ‚ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð² (Ð¾ÑÐ½Ð¾Ð²Ð½Ð°Ñ Ð»Ð¾Ð³Ð¸ÐºÐ° offline Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹)
self.addEventListener('fetch', (event) => {
  const { request } = event;
  const url = new URL(request.url);
  
  // Ð˜Ð³Ð½Ð¾Ñ€Ð¸Ñ€ÑƒÐµÐ¼ Ð½Ðµ-GET Ð·Ð°Ð¿Ñ€Ð¾ÑÑ‹ Ð¸ chrome-extension
  if (request.method !== 'GET' || url.protocol === 'chrome-extension:') {
    return;
  }
  
  // ðŸš¨ ÐšÐ Ð˜Ð¢Ð˜Ð§Ð•Ð¡ÐšÐ˜ Ð’ÐÐ–ÐÐž: ÐÐ• ÐºÑÑˆÐ¸Ñ€ÑƒÐµÐ¼ Supabase API Ð·Ð°Ð¿Ñ€Ð¾ÑÑ‹!
  // Ð­Ñ‚Ð¾ Ð¿Ñ€ÐµÐ´Ð¾Ñ‚Ð²Ñ€Ð°Ñ‰Ð°ÐµÑ‚ ÑƒÑ‚ÐµÑ‡ÐºÑƒ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð¼ÐµÐ¶Ð´Ñƒ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑÐ¼Ð¸
  if (url.hostname.includes('supabase.co')) {
    console.log('[SW] NEVER CACHE: Supabase API request:', request.url);
    event.respondWith(fetch(request));
    return;
  }
  
  // Ð¡Ñ‚Ñ€Ð°Ñ‚ÐµÐ³Ð¸Ñ ÐºÑÑˆÐ¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ: Cache First Ð´Ð»Ñ ÑÑ‚Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ñ… Ñ€ÐµÑÑƒÑ€ÑÐ¾Ð²
  if (STATIC_ASSETS.some(asset => url.pathname.endsWith(asset.split('/').pop()))) {
    event.respondWith(
      caches.match(request)
        .then((cachedResponse) => {
          if (cachedResponse) {
            console.log('[SW] Serving from cache:', request.url);
            return cachedResponse;
          }
          
          // Ð•ÑÐ»Ð¸ Ð½ÐµÑ‚ Ð² ÐºÑÑˆÐµ, Ð·Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ Ð¸Ð· ÑÐµÑ‚Ð¸
          return fetch(request)
            .then((response) => {
              // ÐšÑÑˆÐ¸Ñ€ÑƒÐµÐ¼ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ ÑƒÑÐ¿ÐµÑˆÐ½Ñ‹Ðµ Ð¾Ñ‚Ð²ÐµÑ‚Ñ‹
              if (response.status === 200) {
                const responseClone = response.clone();
                caches.open(STATIC_CACHE_NAME)
                  .then((cache) => {
                    cache.put(request, responseClone);
                  });
              }
              return response;
            })
            .catch(() => {
              // Ð•ÑÐ»Ð¸ Ð¾Ñ„Ð»Ð°Ð¹Ð½ Ð¸ Ð½ÐµÑ‚ Ð² ÐºÑÑˆÐµ, Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÐ¼ fallback
              if (request.destination === 'document') {
                return caches.match('/wishlist-checker/index.html');
              }
            });
        })
    );
    return;
  }
  
  // Ð¡Ñ‚Ñ€Ð°Ñ‚ÐµÐ³Ð¸Ñ Network First Ð´Ð»Ñ Ð´Ð¸Ð½Ð°Ð¼Ð¸Ñ‡ÐµÑÐºÐ¾Ð³Ð¾ ÐºÐ¾Ð½Ñ‚ÐµÐ½Ñ‚Ð°
  event.respondWith(
    fetch(request)
      .then((response) => {
        // ÐšÑÑˆÐ¸Ñ€ÑƒÐµÐ¼ ÑƒÑÐ¿ÐµÑˆÐ½Ñ‹Ðµ Ð¾Ñ‚Ð²ÐµÑ‚Ñ‹
        if (response.status === 200) {
          const responseClone = response.clone();
          caches.open(DYNAMIC_CACHE_NAME)
            .then((cache) => {
              cache.put(request, responseClone);
            });
        }
        return response;
      })
      .catch(() => {
        // Ð•ÑÐ»Ð¸ ÑÐµÑ‚ÑŒ Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð°, Ð¿Ñ€Ð¾Ð±ÑƒÐµÐ¼ ÐºÑÑˆ
        return caches.match(request)
          .then((cachedResponse) => {
            if (cachedResponse) {
              console.log('[SW] Serving from dynamic cache (offline):', request.url);
              return cachedResponse;
            }
            
            // Ð”Ð»Ñ HTML ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ† Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÐ¼ index.html
            if (request.destination === 'document') {
              return caches.match('/wishlist-checker/index.html');
            }
            
            // Ð”Ð»Ñ Ð¾ÑÑ‚Ð°Ð»ÑŒÐ½Ñ‹Ñ… Ñ€ÐµÑÑƒÑ€ÑÐ¾Ð² Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÐ¼ Ð¾ÑˆÐ¸Ð±ÐºÑƒ
            return new Response('Offline - resource not available', {
              status: 503,
              statusText: 'Service Unavailable'
            });
          });
      })
  );
});

// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹ Ð¾Ñ‚ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð° (Ð´Ð»Ñ Ð¿Ñ€Ð¸Ð½ÑƒÐ´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾Ð³Ð¾ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ)
self.addEventListener('message', (event) => {
  if (event.data === 'SKIP_WAITING') {
    console.log('[SW] Received SKIP_WAITING message');
    self.skipWaiting();
  }
  
  if (event.data === 'GET_VERSION') {
    event.ports[0].postMessage({ version: CACHE_NAME });
  }
});

// Ð¡Ð¸Ð½Ñ…Ñ€Ð¾Ð½Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð² Ñ„Ð¾Ð½Ðµ (Ð´Ð»Ñ Ð±ÑƒÐ´ÑƒÑ‰Ð¸Ñ… Ð²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾ÑÑ‚ÐµÐ¹)
self.addEventListener('sync', (event) => {
  console.log('[SW] Background sync:', event.tag);
  
  if (event.tag === 'background-sync') {
    event.waitUntil(
      // Ð—Ð´ÐµÑÑŒ Ð¼Ð¾Ð¶Ð½Ð¾ Ð´Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ Ð»Ð¾Ð³Ð¸ÐºÑƒ ÑÐ¸Ð½Ñ…Ñ€Ð¾Ð½Ð¸Ð·Ð°Ñ†Ð¸Ð¸ Ð´Ð°Ð½Ð½Ñ‹Ñ…
      Promise.resolve()
    );
  }
});

// Ð£Ð²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ñ Push (Ð´Ð»Ñ Ð±ÑƒÐ´ÑƒÑ‰Ð¸Ñ… Ð²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾ÑÑ‚ÐµÐ¹)
self.addEventListener('push', (event) => {
  console.log('[SW] Push notification received');
  
  const options = {
    body: event.data ? event.data.text() : 'Wishlist Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½!',
    icon: '/wishlist-checker/icons/icon-192x192.png',
    badge: '/wishlist-checker/icons/icon-192x192.png',
    vibrate: [100, 50, 100],
    data: {
      dateOfArrival: Date.now(),
      primaryKey: 1
    }
  };
  
  event.waitUntil(
    self.registration.showNotification('Wishlist', options)
  );
});

console.log('[SW] Service Worker script loaded'); 